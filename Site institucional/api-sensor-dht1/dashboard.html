<!doctype html>
<html>

<head>
    <title>Tomato π</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/moment.js/2.18.1/moment.min.js"></script>
    <script src="http://www.chartjs.org/dist/2.7.1/Chart.js"></script>
    <script src="http://www.chartjs.org/samples/latest/utils.js"></script>
    <style>
        canvas {
            -moz-user-select: none;
            -webkit-user-select: none;
            -ms-user-select: none;
        }
    </style>
    <link rel="stylesheet" href="../api site/assets/css/style.css">
</head>

<body id="fundo">
    <div class="header">
        <div class="container">
            <h1 id="logotipo"> <img src="../api site/assets/img/logo final branco.png" style="height: 70px;"></h1>
            <ul class="navbar">
                <li><a href="../api site/index.html">Inicio</a></li>
                <li><a href="../api site/simulador financeiro.html">Simulador</a></li>
                <li><a href="../api site/cadastro.html">Cadastro</a></li>
                <li><a href="../api site/login.html">Login</a> </li>
                <li class="active"><a>Dashboard</a></li>
            </ul>
        </div>
    </div>

    <div id="user" class="container">
        <h1>Controle de temperatura e umidade</h1><br>
        <h4>Empresa:</h4><br><br>
        <h4>Fazenda:</h4><br><br>
        <h4>Usuário:</h4>
    </div>

    <div class="container" id="conteudo">
        <div>
            <section>
                <h3>Umidade média do ambiente: <label id='average'>0.00</label></h3>
            </section>
            <section style="width:100%">
                <canvas id="chart"></canvas>
                <section>
        </div>
        <div>
            <section>
                <h3>Temperatura média do ambiente: <label id='average2'>0.00</label></h3>
            </section>
            <section style="width:100%">
                <canvas id="chart2"></canvas>
                <section>
        </div>
    </div>



    <div id="footer">
        Site desenvolvido por alunos Bandtec Digital School © 2021
    </div>

    <script>

        var umidade = [];
        var temperatura = [];
        var media_temp = 0;
        var media_umi = 0;
        var cont = 0;

        var context = document.getElementById("chart").getContext("2d");
        context.canvas.width = 1000;
        context.canvas.height = 300;

        var configuration = {
            type: 'line',
            data: {
                datasets: [{
                    label: "Umidade (%)",
                    type: 'line',
                    borderColor: ['#34baeb'],
                    backgroundColor: ['#34baeb00']

                }]
            },
            options: {
                scales: {
                    xAxes: [{
                        distribution: 'series',
                        ticks: {
                            beginAtZero: true
                        }
                    }],
                    yAxes: [{
                        scaleLabel: {
                            display: true,
                            labelString: 'Umidade (%)'
                        },
                        ticks: {
                            beginAtZero: true
                        }
                    }]
                },
                animation: {
                    duration: 0
                }
            }
        };

        var chart = new Chart(context, configuration);
        this.lastIndexTemp = 0;
        this.time = 0;

        function get_data() {

            var http = new XMLHttpRequest();
            http.open('GET', 'http://localhost:3000/api', false);
            http.send(null);

            var obj = JSON.parse(http.responseText);
            if (obj.data.length == 0) {
                return;
            }



            var _lastIndexTemp = this.lastIndexTemp;
            this.lastIndexTemp = obj.data.length;
            listTemp = obj.data.slice(_lastIndexTemp);

            listTemp.forEach(data => {
                if (chart.data.labels.length == 10 && chart.data.datasets[0].data.length == 10) {
                    chart.data.labels.shift();
                    chart.data.datasets[0].data.shift();
                }

                chart.data.labels.push(this.time++);
                chart.data.datasets[0].data.push(parseFloat(data[0]));
                chart.update();
            });




            listTemp.forEach(data => {
                if (chart2.data.labels.length == 10 && chart2.data.datasets[0].data.length == 10) {
                    chart2.data.labels.shift();
                    chart2.data.datasets[0].data.shift();
                }

                chart2.data.labels.push(this.time++);
                chart2.data.datasets[0].data.push(parseFloat(data[1]));
                chart2.update();

            })

            listTemp.forEach(data => {


                cont += 2;

                for (let i = 0; i <= 1; i++) {
                    temperatura.push(parseFloat(data[1]));
                    umidade.push(parseFloat(data[0]));
                }
                let sum_umi = umidade.reduce((a, b) => a + b);
                let sum_temp = temperatura.reduce((a, b) => a + b);



                media_temp = sum_temp / cont;
                media_umi = sum_umi / cont;
                document.getElementById('average2').textContent = media_temp.toFixed(1);
                document.getElementById('average').textContent = media_umi.toFixed(1);

                if (media_umi == 45) {
                    alert('Nível de umidade: Crítico min');
                }
                else if (media_umi == 45.8) {
                    alert('Nível de umidade: 1° Quartil ');
                }
                else if (media_umi == 48.5) {
                    alert('Nível de umidade: Mediana');
                }
                else if (media_umi == 50) {
                    alert('Nível de umidade: Media');
                }
                else if (media_umi == 56) {
                    alert('Nível de umidade: 3° Quartil');
                }
                else if (media_umi == 63) {
                    alert('Nível de umidade: Crítico max');
                }
                else if (media_temp == 23) {
                    alert('Nível de temperatura: Crítico min');
                }
                else if (media_temp == 23.5) {
                    alert('Nível de temperatura: 1° quartil ');
                }
                else if (media_temp == 25) {
                    alert('Nível de temperatura:Mediana');
                }
                else if (media_temp == 25.7) {
                    alert('Nível de temperatura: Media');
                }
                else if (media_temp == 27) {
                    alert('Nível de temperatura: 3° Quartil');
                }
                else if (media_temp == 28) {
                    alert('Nível de temperatura: Crítico max');
                }
            })

                ;


        }

        setInterval(() => {
            get_data();
        }, 1000);


        var context2 = document.getElementById("chart2").getContext("2d");
        context2.canvas.width = 1000;
        context2.canvas.height = 300;

        var configuration2 = {
            type: 'line',
            data: {
                datasets: [{
                    label: "Temperatura (°C)",
                    type: 'line',
                    borderColor: ['#eb3a34'],
                    backgroundColor: ['#eb3a3400']
                }]
            },
            options: {
                scales: {
                    xAxes: [{
                        distribution: 'series',
                        ticks: {
                            beginAtZero: true
                        }
                    }],
                    yAxes: [{
                        scaleLabel: {
                            display: true,
                            labelString: 'Temperatura (°C)'
                        },
                        ticks: {
                            beginAtZero: true
                        }
                    }]
                },
                animation: {
                    duration: 0
                }
            }
        };

        var chart2 = new Chart(context2, configuration2);


    </script>
</body>

</html>