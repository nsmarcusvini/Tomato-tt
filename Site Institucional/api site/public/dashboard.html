<!doctype html>
<html>

<head>
    <title>Tomato π</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/moment.js/2.18.1/moment.min.js"></script>
    <script src="http://www.chartjs.org/dist/2.7.1/Chart.js"></script>
    <script src="http://www.chartjs.org/samples/latest/utils.js"></script>
    <style>
        canvas {
            -moz-user-select: none;
            -webkit-user-select: none;
            -ms-user-select: none;
        }
    </style>
    <link rel="stylesheet" href="./css/style.css">
</head>

<body id="fundo" onload="validarSessao()">
    <div class="header">
        <div class="container">
            <h1 id="logotipo"> <img src="./assets/img/logo final branco.png" style="height: 70px;">
            </h1>
            <ul class="navbar">
                <li><a href="../api site/public/index.html">Inicio</a></li>
                <li><a href="../api site/public/simulador financeiro.html">Simulador</a></li>
                <li><a href="../api site/public/cadastro.html">Cadastro</a></li>
                <li><a href="../api site/public/login.html">Login</a> </li>
            </ul>
        </div>
    </div>
	
	<div id="msg_atencao">
		
	</div>
	
	<div id="msg_atencao2">
		
	</div>

    <div id="user" class="container">
        <h1>Controle de temperatura e umidade</h1><br>
        <h4>Empresa:</h4><br><br>
        <h4>Fazenda:</h4><br><br>
        <h4>Usuário: <span id="usuarionomespan"></span></h4><br><br>
        <h4>Email: <span id="emailuser"></span></h4>
    </div>


    <div class="container">
        <div id="user">
            <section>
                <h1>Temperatura média do ambiente:</h1>
                <h2>Média: <label id='average2'>0.00</label></h2>
            </section>
            <section style="width:100%">
                <canvas id="chart"></canvas>
                <section>
        
            <section>
                <h1>Umidade média do ambiente:</h1>
                <h2>Média: <label id='average'>0.00</label></h2>
            </section>
            <section style="width:100%">
                <canvas id="chart2"></canvas>
                <section>
        </div>
    </div>
    <script>
        var max_dados_temp = 0;
   var min_dados_temp = 0;
   var max_dados_umi = 0;
   var min_dados_umi = 0;
   var umi_contr = 0;
   var umi_conto = 0;
   var umi_conty = 0;
   var temp_conty = 0;
   var temp_conto = 0;
   var temp_contr = 0;
   var cont = 0;
   var temp = [];
   var umi = [];
   var mediatemp = [];
   var mediaumi = [];
   var esq_umi = 0;
   var dir_umi = 0;
   var meio_umi = 0;
   var esq_temp = 0;
   var dir_temp = 0;
   var meio_temp = 0;
   var prim_quartil_temp = 0;
   var terc_quartil_temp = 0;
   var terc_quartil_umid = 0;
   var prim_quartil_umid = 0;
   var resto_umi = 0;
   var resto_temp = 0;
   var f_temp = 0;
   var f_umi = 0;
   var terc_resto_umi = 0;
   var terc_resto_temp = 0;
   var terc_f_temp = 0;
   var terc_f_umi = 0;
   var scrollPosition = 0;
   const velocity = 1000;
   var temp_total = [];
   var umi_total = [];
   var arquivo;
   var len = 0;
   var momento;

       var context = document.getElementById("chart").getContext("2d");
   context.canvas.width = 1000;
   context.canvas.height = 300;

   var configuration = {
       type: 'line',
       data: {
           datasets: [{
               label: "Umidade (%)",
               borderColor: '#34baeb',
               backgroundColor: '#34baeb50',
           }]
       },
       options: {
           scales: {
               xAxes: [{
                   distribution: 'series',
                   ticks: {
                       beginAtZero: true
                   }
               }],
               yAxes: [{
                   scaleLabel: {
                       display: true,
                       labelString: 'Umidade (%)'
                   },
                   ticks: {
                       beginAtZero: true
                   }
               }]
           },
           animation: {
               duration: 0
           }
       }
   };
   var context2 = document.getElementById("chart2").getContext("2d");
   context2.canvas.width = 1000;
   context2.canvas.height = 300;

   var configuration2 = {
       type: 'line',
       data: {
           datasets: [{
               label: "Temperatura (°C)",
               borderColor: '#34ebab',
               backgroundColor: '#34ebab50',
           }]
       },
       options: {

           scales: {
               xAxes: [{
                   distribution: 'series',
                   ticks: {
                       beginAtZero: true
                   }
               }],
               yAxes: [{
                   scaleLabel: {
                       display: true,
                       labelString: 'Temperatura (°C)'
                   },
                   ticks: {
                       beginAtZero: true
                   }
               }]
           },
           animation: {
               duration: 0
           }
       }
   };

   var chart = new Chart(context, configuration);
   var chart2 = new Chart(context2, configuration2);
       this.lastIndexTemp = 0;
       this.time = 0;

       function get_data() {

           fetch("/medidas/listar", {
           method: "GET",
       }).then(function (resposta) {

           //console.log("resposta: ", resposta);

           resposta.json().then(function (data) {
  
               len = data.length;
               
                   arquivo = data;
                    console.log(`Dados recebidos: ${JSON.stringify(arquivo[len-1])}`);
                   temp_total = [];
                   umi_total = [];
                  
                  
                   for (j = 0; j < data.length; j++) {

                       if (arquivo[j].dadosTemperatura != undefined) {
                           temp_total.push(parseFloat(arquivo[j].dadosTemperatura));
                       }
                       if (arquivo[j].dadosUmidade != undefined) {
                           umi_total.push(parseFloat(arquivo[j].dadosUmidade));

                       }
                   }

                   
       

       


                   cont = temp_total.length;
                   if (chart.data.labels.length == 10 && chart.data.datasets[0].data.length == 10) {
                       chart.data.labels.shift();
                       chart.data.datasets[0].data.shift();
                   }

                   chart.data.labels.push(this.time++);
                   chart.data.datasets[0].data.push(parseFloat(umi_total[umi_total.length - 1]));
                   chart.update();

                   if (chart2.data.labels.length == 10 && chart2.data.datasets[0].data.length == 10) {
                       chart2.data.labels.shift();
                       chart2.data.datasets[0].data.shift();
                   }

                   chart2.data.labels.push(this.time++);
                   chart2.data.datasets[0].data.push(parseFloat(temp_total[temp_total.length - 1]));
                   chart2.update();

                   let sum = umi_total.reduce((a, b) => a + b);
        let sum2 = temp_total.reduce((a, b) => a + b);


        mediaumi = sum / umi_total.length;
        mediatemp = sum2 / umi_total.length;
        document.getElementById('average').textContent = mediaumi.toFixed(1);
        document.getElementById('average2').textContent = mediatemp.toFixed(1);

           });
       }).catch(function (error) {
           console.error(`ERROR`, error);
       });



       }
	   
	   for (var i = 0; i <= temp_total.length; i++){
	   
			if (temp_total[i] >= 27) {
				msg_atencao.innerHTML = (
                    `<p style="color: red">ATENÇÃO!! A Temperatura da sua estufa está em estado crítico!</p><br>`
                );
			}
			
			if (temp_total[i] >= 25 && temp_total[i] < 27) {
				msg_atencao.innerHTML = (
                    `<p style="color: orange">ATENÇÃO!! A Temperatura da sua estufa está em estado de emergência!</p><br>`
                );
			}
			
			if (temp_total[i] < 25 && temp_total[i] > 24) {
				msg_atencao.innerHTML = (
                    `<p style="color: yellow">ATENÇÃO!! A Temperatura da sua estufa está em estado de alerta!</p><br>`
                );
			}
			
			if (temp_total[i] < 22 && temp_total[i] > 21) {
				msg_atencao.innerHTML = (
                    `<p style="color: yellow">ATENÇÃO!! A Temperatura da sua estufa está em estado de alerta!</p><br>`
                );
			}
			
			if (temp_total[i] < 21 && temp_total[i] > 19) {
				msg_atencao.innerHTML = (
                    `<p style="color: orange">ATENÇÃO!! A Temperatura da sua estufa está em estado de emergência!</p><br>`
                );
			}
			
			if (temp_total[i] <= 19) {
				msg_atencao.innerHTML = (
                    `<p style="color: red">ATENÇÃO!! A Temperatura da sua estufa está em estado crítico!</p><br>`
                );
			}
			
			if (temp_total[i] >= 22 && temp_total[i] <= 24){
				msg_atencao.innerHTML = (
                    `<p style="color: green">Captação de temperatura OK!</p><br>`
                );
			}
			
			
			
			if (umi_total[i] >= 16.2) {
				msg_atencao2.innerHTML = (
                    `<p style="color: red">ATENÇÃO!! A Umidade da sua estufa está em estado crítico!</p><br>`
                );
			}
			
			if (umi_total[i] >= 14.2 && umi_total[i] < 16.2) {
				msg_atencao2.innerHTML = (
                    `<p style="color: orange">ATENÇÃO!! A Umidade da sua estufa está em estado de emergência!</p><br>`
                );
			}
			
			if (umi_total[i] < 14.2 && umi_total[i] > 11.2) {
				msg_atencao2.innerHTML = (
                    `<p style="color: yellow">ATENÇÃO!! A Umidade da sua estufa está em estado de alerta!</p><br>`
                );
			}
			
			if (umi_total[i] < 10.8 && umi_total[i] > 7.8) {
				msg_atencao2.innerHTML = (
                    `<p style="color: yellow">ATENÇÃO!! A Umidade da sua estufa está em estado de alerta!</p><br>`
                );
			}
			
			if (umi_total[i] <= 7.8 && umi_total[i] > 5.8) {
				msg_atencao2.innerHTML = (
                    `<p style="color: orange">ATENÇÃO!! A Umidade da sua estufa está em estado de emergência!</p><br>`
                );
			}
			
			if (umi_total[i] <= 5.8) {
				msg_atencao2.innerHTML = (
                    `<p style="color: red">ATENÇÃO!! A Umidade da sua estufa está em estado crítico!</p><br>`
                );
			}
			
			if (umi_total[i] >= 10.8 && umi_total[i] <= 11.2) {
                msg_atencao.innerHTML = (
                    `<p style="color: green">Captação de umidade OK!</p><br>`
                );
            }
	   
		}

       setInterval(() => {
           get_data();
       }, 1000);

       function validarSessao() {
        // aguardar();
    
        var email = sessionStorage.EMAIL_USUARIO;
        var usuarionome = sessionStorage.NOME_USUARIO;
        
            usuarionomespan.innerHTML = (` ${usuarionome} `);         
            emailuser.innerHTML = (` ${email} `);     



            
    }
	
	
    </script>
</body>

</html>